<!DOCTYPE html>
<html>
<head>
    <title>game Room</title>
    <style>
        #game-log {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
        #draw-area {
            border: 1px solid #000;
        }
    </style>
</head>
<body>
    {{ room_name_json|json_script:"room-name" }}
    <h1>game Room: <span id="room-name"></span></h1>
    <div id="game-log"></div><br>
    <input id="game-message-input" type="text" size="100"><br>
    <input id="game-message-submit" type="button" value="Send">

    <h2>Draw Area</h2>
    <canvas id="draw-area" width="800" height="800"></canvas>

    <script>
        const roomName = "{{ room_name }}";
        document.querySelector('#room-name').textContent = roomName;

        const chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/game/' + roomName + '/'
        );
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'game') {
                document.querySelector('#game-log').innerHTML += (data.message + '<br>');
            } else if (data.type === 'draw') {
                drawLine(JSON.parse(data.message));
            }
        };

        chatSocket.onclose = function(e) {
            console.error('game socket closed unexpectedly');
        };

        document.querySelector('#game-message-input').focus();
        document.querySelector('#game-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#game-message-submit').click();
            }
        };

        document.querySelector('#game-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#game-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({
                'type': 'game',
                'message': message
            }));
            messageInputDom.value = '';
        };

        // Drawing functionality
        const canvas = document.getElementById('draw-area');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }
        function stopDrawing() {
            isDrawing = false;
        }

        function draw(e) {
            if (!isDrawing) return;
            const currentX = e.offsetX;
            const currentY = e.offsetY;
            drawLine({ x0: lastX, y0: lastY, x1: currentX, y1: currentY });
            chatSocket.send(JSON.stringify({
                'type': 'draw',
                'message': JSON.stringify({ x0: lastX, y0: lastY, x1: currentX, y1: currentY })
            }));
            [lastX, lastY] = [currentX, currentY];
        }   

        function drawLine(line) {
            ctx.beginPath();
            ctx.moveTo(line.x0, line.y0);
            ctx.lineTo(line.x1, line.y1);
            ctx.stroke();
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
    </script>
</body>
</html>